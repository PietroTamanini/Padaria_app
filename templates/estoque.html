{% extends "base.html" %}

{% block title %}Estoque - A Turma do Forno{% endblock %}

{% block content %}
<div class="estoque">
    <h2><i class="fas fa-boxes"></i> Controle de Estoque</h2>
    
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Preço</th>
                    <th>Quantidade</th>
                    <th>Status</th>
                    <th>Categoria</th>
                    {% if has_permission('alterar_estoque') %}
                    <th>Ações</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for produto in produtos %}
                <tr class="{% if produto.quantidade < produto.estoque_minimo %}estoque-baixo{% endif %}">
                    <td>{{ produto.id }}</td>
                    <td>{{ produto.nome }}</td>
                    <td>R$ {{ "%.2f"|format(produto.preco) }}</td>
                    <td>{{ produto.quantidade }}</td>
                    <td>
                        {% if produto.quantidade < produto.estoque_minimo %}
                        <span class="badge estoque-baixo-badge">ESTOQUE BAIXO</span>
                        {% else %}
                        <span class="badge estoque-ok">OK</span>
                        {% endif %}
                    </td>
                    <td>{{ produto.categoria }}</td>
                    {% if has_permission('alterar_estoque') %}
                    <td>
                        <div class="acoes-estoque">
                            <button class="btn-secondary" onclick="abrirModalEstoque({{ produto.id }}, '{{ produto.nome }}')">
                                <i class="fas fa-plus"></i> Estoque
                            </button>
                            <a href="/excluir_produto/{{ produto.id }}" class="btn-danger" onclick="return confirm('Tem certeza que deseja excluir o produto \'{{ produto.nome }}\'?')">
                                <i class="fas fa-trash"></i> Excluir
                            </a>
                        </div>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal para aumentar estoque -->
<div id="modal-estoque" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h3>Aumentar Estoque</h3>
        <form method="POST" action="{{ url_for('aumentar_estoque') }}">
            <input type="hidden" name="produto_id" id="modal-produto-id">
            <div class="form-group">
                <label>Produto:</label>
                <input type="text" id="modal-produto-nome" readonly class="form-control">
            </div>
            <div class="form-group">
                <label>Quantidade:</label>
                <input type="number" name="quantidade" min="1" required class="form-control">
            </div>
            <div class="form-group">
                <label>Data:</label>
                <input type="date" name="data" required class="form-control" value="{{ now().strftime('%Y-%m-%d') }}">
            </div>
            <button type="submit" class="btn-primary">Confirmar</button>
            <button type="button" class="btn-secondary" onclick="fecharModalEstoque()">Cancelar</button>
        </form>
    </div>
</div>

<script>
// Função para abrir modal de estoque - COM DEBUG
function abrirModalEstoque(produtoId, produtoNome) {
    console.log('DEBUG - Abrindo modal:');
    console.log('Produto ID:', produtoId);
    console.log('Produto Nome:', produtoNome);
    
    // Verificar se elementos existem
    const modalId = document.getElementById('modal-produto-id');
    const modalNome = document.getElementById('modal-produto-nome');
    const modal = document.getElementById('modal-estoque');
    
    if (!modalId || !modalNome || !modal) {
        console.error('ERRO: Elementos do modal não encontrados!');
        alert('Erro: Elementos do modal não carregados. Recarregue a página.');
        return;
    }
    
    modalId.value = produtoId;
    modalNome.value = produtoNome;
    
    modal.style.display = 'block';
    console.log('Modal aberto com sucesso!');
}

// Função para fechar modal de estoque
function fecharModalEstoque() {
    const modal = document.getElementById('modal-estoque');
    if (modal) {
        modal.style.display = 'none';
        console.log('Modal fechado');
    }
}

// Event listeners seguros para o modal
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM carregado - configurando modal de estoque');
    
    const closeBtn = document.querySelector('.close-btn');
    if (closeBtn) {
        closeBtn.addEventListener('click', fecharModalEstoque);
        console.log('Botão fechar configurado');
    } else {
        console.error('Botão fechar não encontrado!');
    }
    
    // Fechar modal ao clicar fora
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('modal-estoque');
        if (event.target === modal) {
            fecharModalEstoque();
        }
    });
    
    // Fechar modal com ESC
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            fecharModalEstoque();
        }
    });
    
    // Debug: verificar se os elementos do modal existem
    console.log('Modal elemento:', document.getElementById('modal-estoque'));
    console.log('Input ID elemento:', document.getElementById('modal-produto-id'));
    console.log('Input Nome elemento:', document.getElementById('modal-produto-nome'));
});
</script>

<style>
.acoes-estoque {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.acoes-estoque button,
.acoes-estoque a {
    padding: 8px 12px;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 5px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
}

.acoes-estoque .btn-secondary {
    background: linear-gradient(135deg, var(--secondary) 0%, var(--accent) 100%);
    color: white;
}

.acoes-estoque .btn-secondary:hover {
    background: linear-gradient(135deg, var(--accent) 0%, var(--secondary) 100%);
    transform: translateY(-2px);
}

.acoes-estoque .btn-danger {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    color: white;
}

.acoes-estoque .btn-danger:hover {
    background: linear-gradient(135deg, #c82333 0%, #dc3545 100%);
    transform: translateY(-2px);
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: var(--card-bg);
    margin: 10% auto;
    padding: 30px;
    border-radius: 15px;
    width: 90%;
    max-width: 500px;
    position: relative;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
}

.close-btn {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    position: absolute;
    right: 20px;
    top: 15px;
}

.close-btn:hover {
    color: black;
}

.form-control {
    width: 100%;
    padding: 10px;
    border: 2px solid var(--primary-light);
    border-radius: 5px;
    margin-bottom: 15px;
}

.estoque-baixo {
    background-color: #fff5f5;
}

.estoque-baixo:hover {
    background-color: #ffe5e5;
}

.badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
}

.estoque-baixo-badge {
    background-color: #dc3545;
    color: white;
}

.estoque-ok {
    background-color: #28a745;
    color: white;
}

@media (max-width: 768px) {
    .acoes-estoque {
        flex-direction: column;
    }
    
    .acoes-estoque button,
    .acoes-estoque a {
        width: 100%;
        justify-content: center;
    }
    
    .modal-content {
        margin: 20% auto;
        padding: 20px;
        width: 95%;
    }
    
    table {
        font-size: 0.9rem;
    }
    
    .badge {
        font-size: 0.7rem;
        padding: 3px 6px;
    }
}

@media (max-width: 480px) {
    .modal-content {
        margin: 10% auto;
        padding: 15px;
        width: 98%;
    }
    
    .close-btn {
        font-size: 24px;
        right: 15px;
        top: 10px;
    }
    
    .form-control {
        padding: 8px;
        font-size: 0.9rem;
    }
    
    h2 {
        font-size: 1.5rem;
    }
}
</style>
{% endblock %}