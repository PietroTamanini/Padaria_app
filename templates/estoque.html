{% extends "base.html" %}

{% block title %}Estoque - A Turma do Forno{% endblock %}

{% block content %}
<div class="estoque">
    <h2><i class="fas fa-boxes"></i> Controle de Estoque</h2>
    
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Preço</th>
                    <th>Quantidade</th>
                    <th>Status</th>
                    <th>Categoria</th>
                    {% if has_permission('alterar_estoque') %}
                    <th>Ações</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for produto in produtos %}
                <tr class="{% if produto.quantidade < produto.estoque_minimo %}estoque-baixo{% endif %}">
                    <td>{{ produto.id }}</td>
                    <td>{{ produto.nome }}</td>
                    <td>R$ {{ "%.2f"|format(produto.preco) }}</td>
                    <td>{{ produto.quantidade }}</td>
                    <td>
                        {% if produto.quantidade < produto.estoque_minimo %}
                        <span class="badge estoque-baixo-badge">ESTOQUE BAIXO</span>
                        {% else %}
                        <span class="badge estoque-ok">OK</span>
                        {% endif %}
                    </td>
                    <td>{{ produto.categoria }}</td>
                    {% if has_permission('alterar_estoque') %}
                    <td>
                        <button class="btn-secondary" onclick="abrirModalAumentarEstoque({{ produto.id }}, '{{ produto.nome }}')">
                            Aumentar Estoque
                        </button>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal para aumentar estoque -->
<div id="modal-estoque" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>Aumentar Estoque</h3>
        <form id="form-estoque" method="POST" action="{{ url_for('aumentar_estoque') }}">
            <input type="hidden" id="produto_id" name="produto_id">
            <div class="form-group">
                <label for="produto_nome">Produto:</label>
                <input type="text" id="produto_nome" readonly>
            </div>
            <div class="form-group">
                <label for="quantidade">Quantidade:</label>
                <input type="number" id="quantidade" name="quantidade" min="1" required>
            </div>
            <div class="form-group">
                <label for="data">Data:</label>
                <input type="date" id="data" name="data" required>
            </div>
            <button type="submit" class="btn-primary">Confirmar</button>
        </form>
    </div>
</div>

<script>
// Modal para aumentar estoque
function abrirModalAumentarEstoque(produtoId, produtoNome) {
    document.getElementById('produto_id').value = produtoId;
    document.getElementById('produto_nome').value = produtoNome;
    document.getElementById('modal-estoque').style.display = 'block';
    
    // Definir data atual
    const hoje = new Date();
    const dataFormatada = hoje.toISOString().split('T')[0];
    document.getElementById('data').value = dataFormatada;
}

// Fechar modal quando clicar no X
document.querySelector('.close').addEventListener('click', function() {
    document.getElementById('modal-estoque').style.display = 'none';
});

// Fechar modal quando clicar fora dele
window.addEventListener('click', function(event) {
    const modal = document.getElementById('modal-estoque');
    if (event.target === modal) {
        modal.style.display = 'none';
    }
});
</script>
{% endblock %}